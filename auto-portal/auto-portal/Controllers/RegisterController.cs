using auto_portal.DAL;
using auto_portal.Helpers;
using auto_portal.Models;
using auto_portal.ViewModel;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Web;
using System.Web.Mvc;
using auto_portal.ViewModel.CarRegister;
using AutoMapper;

namespace auto_portal.Controllers
{
    [Authorize]
    public class RegisterController : Controller
    {
        private readonly ManagementVehicle manager;
        // GET: Register

        public RegisterController()
        {
            manager = new ManagementVehicle();
        }
        public ActionResult Index()
        {
            return View();
        }

        public ActionResult AddNewRegister(int id)
        {
            var vm = Mapper.Map<AddEditCarRegisterViewModel>(manager.GetVehicleById(id));
            
            return View(vm);
        }

        [HttpPost]
        public ActionResult AddNewRegister(AddEditCarRegisterViewModel vm)
        {
            
            return View(vm);
        }

        public ActionResult ChooseYourCar()
        {
            return View();
        }

        [HttpPost]
        public ActionResult ChooseYourCar(CarChoiceViewModel vm)
        {
            return RedirectToAction("AddNewRegister", new { @id = vm.CarId });
        }


        [HttpGet]
        public ActionResult GetCars(string searchTerm, int pageSize, int pageNum)
        {
            List<Vehicle> cars = manager.GetVehicles(searchTerm, pageSize, pageNum);
            int carsCount = manager.GetVehiclesCount(searchTerm, pageSize, pageNum);
            Select2PagedResult pagedCars = CarsToSelect2Format(cars, carsCount);

            //Return the data as a jsonp result
            return new JsonpResult
            {
                Data = pagedCars,
                JsonRequestBehavior = JsonRequestBehavior.AllowGet
            };
        }

        private static Select2PagedResult CarsToSelect2Format(IEnumerable<Vehicle> vehicles, int totalCars)
        {
            var jsonCars = new Select2PagedResult {Results = new List<Select2Result>()};
            foreach (var a in vehicles)
            {
                jsonCars.Results.Add(new Select2Result { id = a.Id.ToString(), text = a.Producer + " " + a.Model + " (" + a.GetProductionYears + " ) " });
            }
            jsonCars.Total = totalCars;
            return jsonCars;
        }
    }

    //Extra classes to format the results the way the select2 dropdown wants them
    public class Select2PagedResult
    {
        public int Total { get; set; }
        public List<Select2Result> Results { get; set; }
    }

    public class Select2Result
    {
        public string id { get; set; }
        public string text { get; set; }
    }
}